# This config is meant to be consumed by the config transpiler, which will
# generate the corresponding Ignition config. Do not pass this config directly
# to instances of Container Linux.
systemd:
  units:
    - name: var-tokens.mount
      enable: true
      contents: |
        [Mount]
        What=efs-mount-target:/
        Where=/var/tokens
        Type=nfs
        [Install]
        WantedBy=multi-user.target
    - name: swarm.service
      enable: true
      contents: |
        [Unit]
        Description="Swarm initialisation"
        After=docker.service var-tokens.mount
        Requires=docker.service var-tokens.mount

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/sh /home/core/swarm-init.sh

        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: /home/core/swarm-init.sh
      filesystem: root
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env bash

          set -eux

          JOIN_TOKEN=''
          echo "Trying to join a swarm at swarm.local..."
          while [ -z $JOIN_TOKEN ]; do
            JOIN_TOKEN=$(cat /var/tokens/worker)
            if [ -z $JOIN_TOKEN ]; then
              sleep 10
            fi
          done

          MANAGER_IPS="$(getent hosts swarm.local|awk '{ print $1 }')"
          for IP in $MANAGER_IPS; do
            echo "Trying to join a swarm managed by $IP..."
            if wget -q --spider -t 1 --connect-timeout 3 $IP:2377; then
              docker swarm join --token $JOIN_TOKEN $IP:2377
              break
            fi
            echo "...Timeout"
          done

locksmith:
  reboot_strategy: off
